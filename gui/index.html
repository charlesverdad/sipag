<!DOCTYPE html>
  <html>
    <head>
      <meta charset="UTF-8">
      <title>Hello World!</title>
    </head>
    <body>

      <canvas id="myChart" width="300" height="300"></canvas>


      <script src="./node_modules/chart.js/dist/Chart.js"></script>
      <script>
        // var myChart = new Chart(ctx, {
        //     type: 'bar',
        //     data: {
        //         labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
        //         datasets: [{
        //             label: '# of Votes',
        //             data: [12, 19, 3, 5, 2, 3],
        //             backgroundColor: [
        //                 'rgba(255, 99, 132, 0.2)',
        //                 'rgba(54, 162, 235, 0.2)',
        //                 'rgba(255, 206, 86, 0.2)',
        //                 'rgba(75, 192, 192, 0.2)',
        //                 'rgba(153, 102, 255, 0.2)',
        //                 'rgba(255, 159, 64, 0.2)'
        //             ],
        //             borderColor: [
        //                 'rgba(255,99,132,1)',
        //                 'rgba(54, 162, 235, 1)',
        //                 'rgba(255, 206, 86, 1)',
        //                 'rgba(75, 192, 192, 1)',
        //                 'rgba(153, 102, 255, 1)',
        //                 'rgba(255, 159, 64, 1)'
        //             ],
        //             borderWidth: 1
        //         }]
        //     },
        //     options: {
        //         scales: {
        //             yAxes: [{
        //                 ticks: {
        //                     beginAtZero:true
        //                 }
        //             }]
        //         }
        //     }
        // });

        function pad_num(n){
          // pads a number with leading zero to make it two digits
          n = n.toString();
          if (n.length == 1){
            return "0" + n;
          } else{
            return n;
          }
        }

        function get_app_path(){
          // returns OS-specific path to the sipag application data folder
          if (navigator.platform == 'Win32'){
            return process.env.APPDATA + '\\Likha\\sipag\\';
          } else {
            return process.env.HOME + '/.sipag/';
          }
        }

        function get_app_data_path(date=null) {
          // returns path to the json file containing the application data
          if (date == null){
            // assume current date
            d = new Date();
            fn = d.getFullYear() + "_" + pad_num(d.getMonth()+1) + "_" + pad_num(d.getDay()+1) + "_" + "usage.json";
            return get_app_path() + fn;
          }
        }

        function dict_sort(dict){
          // sorts a dictionary using its values.
          // returns array of 2-length arrays.
          // adapted from https://stackoverflow.com/questions/25500316/sort-a-dictionary-by-value-in-javascript

          var items = Object.keys(dict).map(function(key) {
            return [key, dict[key]];
          });

          items.sort(function(first, second) {
            return second[1] - first[1];
          });

          return items
        }

        function getRandomColor() {
          //adapted from https://stackoverflow.com/questions/1484506/random-color-generator
          var letters = '0123456789ABCDEF';
          var color = '#';
          for (var i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
          }
          return color;
        }

        function get_colors(num){
          // returns an array of random colors with size `num`
          // TODO: instead of randomizing colors, generate one with nice color scheme.
          colors = []
          for (i = 0; i < num; i++) {
            colors.push(getRandomColor())
          }
          return colors
        }

        function reformat_data(data) {
          // formats json string data for doughnut chart
          // data should be a dictionary type, where the keys are the name of the application
          // and the values are seconds.

          items = dict_sort(data)
          sorted_keys = []
          sorted_values = []

          for (i = 0; i < items.length; i++){
            sorted_keys.push(items[i][0])
            sorted_values.push(items[i][1])
          }

          var formatted_data = {
            datasets: [{
              data: sorted_values,
              backgroundColor: get_colors(items.length)
            }],

            labels: sorted_keys
          }
          console.log('here!')
          console.log(formatted_data)
          return formatted_data
        }


        fetch(get_app_data_path())
          .then(response => response.json())
          .then(jsonResponse => reformat_data(jsonResponse))
          .then(resp => update_chart(resp))

        function update_chart(data){
          // updates the main doughnut chart
          var ctx = document.getElementById("myChart");
          var myPieChart = new Chart(ctx,{
            type: 'doughnut',
            data: data,
            options: {
              legend: {
                display: false
              },
              responsive: false
            }
          });
        }

      </script>

      <h1>Hello World!</h1>
      We are using node <script>document.write(process.versions.node)</script>,
      Chrome <script>document.write(process.versions.chrome)</script>,
      and Electron <script>document.write(process.versions.electron)</script>.
    </body>
  </html>